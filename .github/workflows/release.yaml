name: "tagged-release"

on:
  release:
    types:
      - published

jobs:
  ci:
    uses: ./.github/workflows/build.yaml
    with:
      # note >-, args needs to be strings to be used as inputs
      # for the reusable build.yaml workflow
      go-version: >-
        ["1.20.x"]
      privilege-level: >-
        ["priv"]
  release:
    name: "Tagged Release"
    runs-on: ubuntu-20.04
    # needs ci for the cached stacker binary
    needs: ci
    steps:
      - uses: benjlevesque/short-sha@v2.1
        id: short-sha
      - uses: actions/cache@v3
        id: restore-build
        with:
          path: stacker
          key: ${{ github.event.release.tag_name }}-${{ steps.short-sha.outputs.sha }}
      - if: github.event_name == 'release' && github.event.action == 'published'
        name: Publish artifacts on releases
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: stacker
          tag: ${{ github.ref }}
          overwrite: true
          file_glob: true
